{% extends 'pi/common/detail.html' %}

{% load staticfiles %}
{% block page-header %}
	<div>
		{{ object.name }}
		<a href="{% url 'school_edit' object.id %}" class="btn btn-xs addlink">
			<i class="fa fa-plus"></i>
			edit
		</a>

		<div class="btn-group pull-right"> 
		    <button
		    	{% if object in user.myuserprofile.school_bookmarks.all %} 
		    		class="btn btn-small ladda-button btn-primary"
		    	{% else %}
		    		class="btn btn-small ladda-button" 
		    	{% endif %}

		    	id="btn-school-bookmark" 
		    	style="border-right:1px solid #fefefe;margin-right:1px;" 
		    	data-style="expand-left" 
				data-size="l" 
				data-spinner-color="#333" 
				data-toggle="tooltip" 
				title="添加到我的收藏中"
			>
				<span class="ladda-label"></span>			
		    	<i class="fa fa-heart-o"></i>
		    	Bookmark
		    </button>
		    <button 
		    	{% if object in user.myuserprofile.school_xouts.all %} 
		    		class="btn btn-small ladda-button btn-primary"
		    	{% else %}
		    		class="btn btn-small ladda-button" 
		    	{% endif %}
		    	
				data-style="expand-right" 
				data-size="l" 
				data-spinner-color="#333" 		    
		    	data-toggle="tooltip" 
		    	title="我再也不想看见这个学校啦 >_<" 
		    	id="btn-school-xout"
		    >
				<span class="ladda-label"></span>			    
		    	<i class="fa fa-thumbs-o-down"></i>
		    	X-OUT
		    </button>
	  	</div>
  	</div>
{% endblock %}

{% block detail-navbar %}
<ul class="nav navbar-nav">
    <li class="">
        <a href="#school-intro">学校简介
		<span class="pull-right"><i class="fa fa-angle-right"></i></span>
		</a>
    </li>

    <li class="">
    	<a href="#school-major">学校专业
		<span class="pull-right"><i class="fa fa-angle-right"></i></span>    	
    	</a>
    </li>

    <li class="dropdown">
		<a href="#school-admission">
			往年录取分数线
			<span class="pull-right"><i class="fa fa-angle-right"></i></span>
		</a>
    </li>
    <li class="">
    	<a href="#school-stream">
    	聊天啦!
			<span class="pull-right"><i class="fa fa-angle-right"></i></span>
    	</a>
    </li>    
</ul>
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb">
	<li>
		<a href="{% url 'school_echart_map_filter' %}">全国</a>
	</li>
	<li>
		<a href="{% url 'analysis_school_by_province' object.province.id %}">{{object.province}}</a>
	</li>
	<li>
		<a href="{% url 'analysis_school_by_province' 1 %}">{{ object.city }}</a>
	</li>
	<li class="active">{{ object.name }}</li>
</ol>
{% endblock %}

{% block detail-content %}
		{# google map of this school #}
		<section>
			<iframe
			  width="100%"
			  height="250"
			  frameborder="0" style="border:0"
			  src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBs9Lh9SBeGg8azzB5h50y8DDjxFO4SLwA&q={{ object.name }}&language=zh-cn">
			</iframe>
		</section>

		{# school related majors #}
		<section id="school-major">
			<h2 class="my-h2-border">学校专业</h2>

			<ul class="list-inline">
			{% regroup majors|dictsort:"student_type" by student_type as by_major_category_list %}
			{% for student_type in by_major_category_list %}
				<li>
					<h3>
						<i class="fa fa-hand-o-right"></i>			
						<span class="label label-primary">{{ student_type.grouper }}</span>
					</h3>
				</li>
				<ul class="list-inline my-multicol-4">
				{% for ad in student_type.list %}
					<li><a href="{%url 'major_detail' ad.id %}">{{ ad }}</a></li>
				{% endfor %}
				</ul>
			{% endfor %}
			</ul>
		</section>

		{# school admission score tables #}
		<section id="school-admission">
			<h2 class="my-h2-border">录取分数线</h2>

			{% if school_admission_by_year %}
				<ul id="myTab" class="nav nav-tabs">
				{% for year in school_admission_by_year %}
					<li><a href="#school-admission-{{year}}" data-toggle="tab">
						{{year}}年
					</a></li>			
				{% endfor %}
				</ul>

				<div id="myTabContent" class="tab-content">
				{% for year,school_list in school_admission_by_year.items %}
					<div class="tab-pane" id="school-admission-{{year}}">
					{% regroup school_list|dictsort:"category" by category as admission_by_cat %}
					{% for category in admission_by_cat %}
					{# 理科 #}
					<h3>
					<i class="fa fa-hand-o-right"></i>
					<span class="label label-primary">{{ category.grouper }}</span>
					</h3>
						
					
					<table class="table table-condensed table-striped table-hover">
						<thead><tr>
							<th>招生地区</th>
							<th>考生类别</th>
							<th>录取批次</th>
							<th>最低分</th>
							<th>最高分</th>
							<th>平均分</th>
							<th>省控线</th>
						</tr></thead>
						<tbody>
							{% for s in category.list %}
								<tr>
									<td>{{ s.province|default:"暂无信息" }}</td>
									<td>{{ s.category|default:"暂无信息" }}</td>
									<td>{{ s.batch|default:"暂无信息" }}</td>
									<td>{{ s.min_score|default:"&mdash;" }}</td>
									<td>{{ s.max_score|default:"&mdash;" }}</td>
									<td>{{ s.avg_score|default:"&mdash;" }}</td>
									<td>{{ s.province_score|default:"&mdash;"}}</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
					{% endfor %}<!-- end cat loop -->
					</div>
				{%endfor%}<!-- end year loop-->
			</div><!-- end of tab content -->	
			{% else %}
				暂无信息
			{% endif %}					
		</section>

		{# school admission score tables #}
		<section id="school-stream">
			<h2 class="my-h2-border ladda-button" 
			data-style="expand-right" 
			data-size="l" data-spinner-color="#333" id="school-stream-bd">
			同学们都在说什么呢
			<span class="ladda-label">
			</h2>
			<div id="school-tieba"></div>
		</section>		
{% endblock %}

{% block detail-sidebar %}
	{# float to right, attributes #}
	{# school introduction #}
	<section id="school-intro">
		<h4 class="my-h2-border"><i class="fa fa-university"></i>学校简介</h4>
		<div style="overflow:hidden;max-height:300px;">
		{{ object.description|default:"暂无信息"|safe|truncatechars:1000 }}
		</div>
	</section>

	{# hot topics #}
	<h4>
		<i class="fa fa-fire"></i>
		Hot topics
	</h4>
	<ul class="list-unstyled newsticker" style="min-height:240px;overflow:hidden;">
		{% for topic in hot_topics %}
			<li style="border-bottom:1px dashed #dedede;height:50px;">
			<h6 style="color:#89e;">
				<i class="fa fa-bullhorn"></i>
				{{ topic.author }}
			</h6>
			{{ topic.name }}
			</li>
		{% endfor %}
	</ul>

	{# float to right, related #}
	<h4>
		<i class="fa fa-map-marker"></i>
		同城市类似分数的学校
	</h4>
	<ol class="">
		{% for s in related_schools %}
			<li><a href="{% url 'school_detail' s.school.id %}">{{ s.school }}({{s.rank}})</a></li>
		{% endfor %}
	</ol>
{% endblock %}

{% block custom_js %}
<script type="text/javascript">
	function get_bd_tb(){
		// loading spinner
		var l = Ladda.create(j$('#school-stream-bd')[0]);
	 	l.start();
	 			
        // ajax to server to get a list of columns:4"markers that are within the viewport
        j$.post("{% url 'integration_baidu_tieba_ajax' %}", // passed in from view
            { 
                'obj_id':{{ object.id }},
            }, 
            function(resp) { // success callback
                j$('#school-tieba').html(resp['html']);             
                setTimeout(get_bd_tb, 30000); // refresh every 30 seconds
            },'json'
        ).always(function(){
    		// remove spinner
    		l.stop();        	
        });  
	}

	j$(document).ready(function(){
		setTimeout(get_bd_tb,500);

		j$(document).delegate('*[data-toggle="lightbox"]', 'click', function(e) {
		    e.preventDefault();
		    j$(this).ekkoLightbox();
		}); 

		// start news ticker
		j$('.newsticker').newsTicker({
			row_height: 48,
			max_rows: 2,
			speed: 600,
			direction: 'up',
			duration: 4000,
			autostart: 1,
			pauseOnHover: 0			
		});

		j$('#btn-school-bookmark').click(function(){
			var l = Ladda.create(this);
	 		l.start();

	        // ajax to server to get a list of columns:4"markers that are within the viewport
	        j$.post("{% url 'user_bookmark' %}", // passed in from view
	            { 
	                'obj_id':{{ object.id }},
	                'action':1
	            }, 
	            function(resp) { // success callback
	            	if (resp['status'] == 'ok'){
	            		j$('#btn-school-bookmark').toggleClass('btn-primary');
	            		j$('#btn-school-xout').removeClass('btn-primary');
	            	}
	            	update_user_bookmarks();
	            },'json'
	        ).always(function(){     
	        	l.stop(); 	
	        });			
		});
		j$('#btn-school-xout').click(function(){
			var l = Ladda.create(this);
	 		l.start();

	        // ajax to server to get a list of columns:4"markers that are within the viewport
	        j$.post("{% url 'user_bookmark' %}", // passed in from view
	            { 
	                'obj_id':{{ object.id }},
	                'action':2
	            }, 
	            function(resp) { // success callback
	            	if (resp['status'] == 'ok'){
	            		j$('#btn-school-xout').toggleClass('btn-primary');
	            		j$('#btn-school-bookmark').removeClass('btn-primary');
	            	}
	            	update_user_bookmarks();
	            },'json'
	        ).always(function(){  
	        	l.stop();     	
	        });			
		});		

	});
</script>
{% endblock %}